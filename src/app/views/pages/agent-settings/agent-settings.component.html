<form [formGroup]="form" (ngSubmit)="save()">
  <c-card class="p-3 shadow-sm">
    <div class="d-flex align-items-center mb-3">
      <h5 class="mb-0">Configuración del agente</h5>
      <span class="badge bg-light text-dark ms-2">{{ agent?.displayName }}</span>
      <div class="ms-auto d-flex gap-2">
        <button type="button" cButton color="secondary" variant="outline" (click)="cancel()">Cancelar</button>
        <button type="submit" cButton color="primary" [disabled]="loading">
          <svg cIcon name="cilSave" class="me-1"></svg> Guardar
        </button>
      </div>
    </div>

    <c-tabs [activeItemKey]="activeItemKey" (activeItemKeyChange)="handleChange($event)">
      <c-tabs-list variant="tabs">
        <button cTab itemKey="basic"><svg cIcon name="cilHome"></svg> BÁSICO</button>
        <button cTab itemKey="voz">VOZ & LLM</button>
        <button cTab itemKey="prompt">PROMPT</button>
        <button cTab itemKey="conversacion">CONVERSACIÓN</button>
        <button cTab itemKey="plataforma">PLATAFORMA</button>
        <button cTab itemKey="knowledge">KNOWLEDGE BASE</button>
        <button cTab itemKey="tools">TOOLS</button>
      </c-tabs-list>

      <c-tabs-content>
        <c-tab-panel class="p-3" itemKey="basic">
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Nombre *</label>
              <input class="form-control" formControlName="name" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Descripción</label>
              <input class="form-control" formControlName="description" />
            </div>

            <div class="col-12" formArrayName="tags">
              <label class="form-label d-flex align-items-center">
                <svg cIcon name="cilTag" class="me-2"></svg> Tags
              </label>
              <div class="d-flex flex-wrap gap-2">
                <ng-container *ngFor="let _ of tagsFA.controls; let i = index">
                  <div class="input-group" style="max-width:280px;">
                    <input class="form-control" [formControlName]="i" placeholder="tag..." />
                    <button type="button" cButton color="danger" variant="outline" (click)="removeTag(i)">
                      <svg cIcon name="cilTrash"></svg>
                    </button>
                  </div>
                </ng-container>
                <button type="button" cButton color="secondary" variant="outline" (click)="addTag()">
                  <svg cIcon name="cilPlus"></svg> Añadir tag
                </button>
              </div>
            </div>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="voz">
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label d-flex align-items-center">
                <svg cIcon name="cilVoiceOverRecord" class="me-2"></svg> Voz
              </label>
              <div class="d-flex align-items-center gap-2">
                <button type="button" cButton color="secondary" variant="outline" (click)="openVoicesModal()">Elegir
                  voz</button>
                <span class="text-muted" *ngIf="!form.get('voice_id')?.value">Ninguna</span>
                <ng-container *ngIf="form.get('voice_id')?.value as selId">
                  <ng-container *ngFor="let v of voices">
                    <span *ngIf="v.voice_id === selId" class="badge bg-light text-dark">
                      🎤 {{ v.name }} · {{ getVoiceSummary(v) }}
                    </span>
                  </ng-container>
                </ng-container>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label">LLM Model</label>
              <input class="form-control" formControlName="llm_model" />
            </div>

            <div class="col-md-2">
              <label class="form-label">Temperature</label>
              <input type="number" step="0.1" min="0" max="2" class="form-control" formControlName="temperature" />
            </div>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="prompt">
          <div class="mt-2">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">First message</label>
                <input class="form-control" formControlName="first_message"
                  placeholder="Ej: ¡Hola! ¿En qué puedo ayudarte?" />
                <small class="text-muted">Mensaje inicial que enviará el agente.</small>
              </div>
              <div class="col-md-3">
                <label class="form-label">Language</label>
                <input class="form-control" formControlName="language" placeholder="es, en, fr..." />
                <small class="text-muted">Código de idioma (ej.: es, en, fr).</small>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">System prompt</label>
              <textarea class="form-control" rows="3" formControlName="system_prompt"
                placeholder="Instrucciones de comportamiento general..."></textarea>
            </div>

            <div class="mt-3">
              <label class="form-label">Prompt (cliente)</label>
              <textarea class="form-control" rows="4" formControlName="prompt"
                placeholder="Prompt específico que el cliente quiere aplicar..."></textarea>
            </div>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="conversacion">
          <div class="mt-2" formGroupName="conversation_config">
            <h6>ASR</h6>
            <div formGroupName="asr">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Provider</label>
                  <input class="form-control" formControlName="provider" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Quality</label>
                  <input class="form-control" formControlName="quality" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Audio format</label>
                  <input class="form-control" formControlName="user_input_audio_format" />
                </div>

                <div class="col-12" formArrayName="keywords">
                  <label class="form-label">Keywords</label>
                  <div class="d-flex flex-wrap gap-2">
                    <ng-container *ngFor="let _ of keywordsFA.controls; let i = index">
                      <div class="input-group" style="max-width:260px;">
                        <input class="form-control" [formControlName]="i" placeholder="keyword..." />
                        <button type="button" cButton color="danger" variant="outline" (click)="removeKeyword(i)">
                          <svg cIcon name="cilTrash"></svg>
                        </button>
                      </div>
                    </ng-container>
                    <button type="button" cButton color="secondary" variant="outline" (click)="addKeyword()">
                      <svg cIcon name="cilPlus"></svg> Añadir keyword
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <hr>

            <h6>TTS</h6>
            <div formGroupName="tts">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Stability</label>
                  <input class="form-control" type="number" step="0.1" formControlName="stability" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Similarity boost</label>
                  <input class="form-control" type="number" step="0.1" formControlName="similarity_boost" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Speed</label>
                  <input class="form-control" type="number" step="0.05" min="0.5" max="2" formControlName="speed" />
                  <small class="text-muted">1.0 = normal, &gt;1 más rápido, &lt;1 más lento.</small>
                </div>
              </div>
            </div>

            <hr>

            <h6>Turn</h6>
            <div formGroupName="turn">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Turn timeout (s)</label>
                  <input class="form-control" type="number" formControlName="turn_timeout" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Silence end call (s)</label>
                  <input class="form-control" type="number" formControlName="silence_end_call_timeout" />
                </div>
              </div>
            </div>

            <hr>

            <h6>LLM (conversación)</h6>
            <div formGroupName="llm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Model Id</label>
                  <input class="form-control" formControlName="model_id" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Temperature</label>
                  <input class="form-control" type="number" step="0.1" formControlName="temperature" />
                </div>
              </div>
            </div>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="plataforma">
          <div class="mt-2" formGroupName="platform_settings">
            <h6>Webchat</h6>
            <div class="row g-3" formGroupName="webchat">
              <div class="col-md-3 form-check form-switch">
                <input class="form-check-input" type="checkbox" id="bargeIn" formControlName="barge_in">
                <label class="form-check-label" for="bargeIn">Barge-in</label>
              </div>
              <div class="col-md-3 form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showTyping" formControlName="show_typing">
                <label class="form-check-label" for="showTyping">Mostrar “escribiendo...”</label>
              </div>
            </div>

            <hr>

            <h6>Phone</h6>
            <div class="row g-3" formGroupName="phone">
              <div class="col-md-3 form-check form-switch">
                <input class="form-check-input" type="checkbox" id="dtmf" formControlName="dtmf_enabled">
                <label class="form-check-label" for="dtmf">DTMF habilitado</label>
              </div>
            </div>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="knowledge">
          <div class="mt-2" formGroupName="knowledge_base">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Modo de uso</label>
                <select class="form-select" formControlName="usage_mode">
                  <option value="auto">Auto</option>
                  <option value="always">Always</option>
                  <option value="never">Never</option>
                </select>
              </div>
            </div>
            <small class="text-muted">Configura cómo el agente usa su base de conocimiento. (Sin exponer
              webhooks)</small>
          </div>
        </c-tab-panel>
        <c-tab-panel class="p-3" itemKey="tools">
          <div class="mt-2" formArrayName="tools">
            <div class="d-flex flex-wrap gap-2">
              <ng-container *ngFor="let _ of toolsFA.controls; let i = index">
                <c-card class="p-3" style="min-width:320px;" [formGroupName]="i">
                  <div class="mb-2">
                    <label class="form-label">Tool ID</label>
                    <input class="form-control" formControlName="tool_id" placeholder="tool_weather" />
                  </div>
                  <div>
                    <label class="form-label">Config (JSON)</label>
                    <textarea class="form-control" rows="4" formControlName="tool_config"
                      placeholder='{"units":"metric"}'></textarea>
                  </div>
                  <div class="mt-2 text-end">
                    <button type="button" cButton color="danger" variant="outline" (click)="removeTool(i)">
                      <svg cIcon name="cilTrash"></svg> Quitar
                    </button>
                  </div>
                </c-card>
              </ng-container>

              <button type="button" cButton color="secondary" variant="outline" (click)="addTool()">
                <svg cIcon name="cilPlus"></svg> Añadir Tool
              </button>
            </div>
          </div>
        </c-tab-panel>
      </c-tabs-content>
    </c-tabs>
  </c-card>

  <!-- ========= MODAL: Selector de voces ========= -->
  <c-modal [visible]="voicesModal" (visibleChange)="voicesModal=$event" size="lg" backdrop="static">
    <c-modal-header>
      <h5 class="modal-title">Seleccionar voz de ElevenLabs</h5>
      <button cButtonClose (click)="closeVoicesModal()"></button>
    </c-modal-header>

    <c-modal-body>
      <div class="input-group mb-3">
        <span class="input-group-text"><svg cIcon name="cilSearch"></svg></span>
        <input class="form-control" [formControl]="voiceSearch"
          placeholder="Buscar por nombre, idioma, género, acento, uso..." />
      </div>

      <div class="border rounded" style="max-height: 420px; overflow:auto;">
        <ul cListGroup flush>
          <button cListGroupItem *ngFor="let v of filteredVoices" (click)="selectVoice(v)" class="text-start">
            <div class="d-flex align-items-center">
              <div class="flex-grow-1">
                <div class="fw-semibold">
                  <svg cIcon name="cilMicrophone" class="me-1"></svg> {{ v.name }}
                </div>
                <div class="small text-muted d-flex flex-wrap">
                  <span class="meta-cell me-2"><svg cIcon name="cilTag"></svg> {{ v.category || 'custom' }}</span>
                  <span class="meta-cell me-2"><svg cIcon name="cilUser"></svg> {{ v.labels?.gender || 'n/a' }}</span>
                  <span class="meta-cell me-2"><svg cIcon name="cilGlobeAlt"></svg> {{ v.labels?.language || '—'
                    }}</span>
                  <span class="meta-cell me-2" [class.invisible]="!v.labels?.accent"><svg cIcon
                      name="cilBullhorn"></svg> {{ v.labels?.accent }}</span>
                  <span class="meta-cell me-2" [class.invisible]="!v.labels?.use_case"><svg cIcon name="cilBadge"></svg>
                    {{ v.labels?.use_case }}</span>
                </div>
              </div>
              <div class="ms-2" *ngIf="v.preview_url">
                <button type="button" cButton color="secondary" size="sm"
                  (click)="$event.stopPropagation(); playVoice(v.preview_url)">
                  <i class="bi bi-play"></i>
                </button>
              </div>
            </div>
          </button>
        </ul>
      </div>
    </c-modal-body>

    <c-modal-footer>
      <button cButton color="secondary" (click)="closeVoicesModal()">Cerrar</button>
    </c-modal-footer>
  </c-modal>
</form>

<style>
  .meta-cell {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    flex: 1 0 20%;
    min-width: 140px;
  }

  .invisible {
    visibility: hidden;
  }
</style>