<!-- Form URL -->
<img [src]="'../../../assets/seo.png'" alt="Avatar" style="width:100%;
    background-size: cover;" />
<c-card class="shadow-sm border-0 mb-4">
  <c-card-body>
    <p style="text-align: center;padding: 25px;">
      Analizamos tu web con IA para detectar los factores que limitan su visibilidad en Google.
      Lira revisa tu velocidad, estructura, contenido y SEO on-page, generando un informe con errores, oportunidades
      y una puntuación global.

      Ideal para saber en qué punto estás y cómo mejorar tu posicionamiento.
    </p>
    <form [formGroup]="form" (ngSubmit)="analyze()" class="row g-3 align-items-end">
      <div class="col-12 col-md-9">

        <label class="form-label" for="url">URL a analizar</label>
        <input cFormControl type="url" id="url" formControlName="url" placeholder="https://www.ejemplo.com"
          class="form-control" [class.is-invalid]="form.get('url')?.invalid && form.get('url')?.touched">
        <div *ngIf="form.get('url')?.invalid && form.get('url')?.touched" class="invalid-feedback">
          Introduce una URL válida.
        </div>
      </div>
      <div class="col-12 col-md-3 d-grid">
        <button cButton color="primary" type="submit" [disabled]="form.invalid || loading">
          <ng-container *ngIf="!loading">Analizar</ng-container>
          <ng-container *ngIf="loading">Analizando...</ng-container>
        </button>
      </div>
    </form>
  </c-card-body>
</c-card>




<c-card class="shadow-sm border-0 mb-4">
  <!-- Barra superior -->
  <div class="d-flex align-items-center gap-2 mb-2 m-4" style="cursor:pointer;">
    <div class="ms-auto align-items-center">
      <label class="mb-0 small text-secondary">Filas por página</label>
      <select style="cursor:pointer;" cSelect class="form-select form-select-sm" [(ngModel)]="pageSize"
        (ngModelChange)="onPageSizeChange($event)">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="25">25</option>
        <option [ngValue]="50">50</option>
      </select>
      <span class="small text-secondary">
        Mostrando {{ totalItems === 0 ? 0 : (page - 1) * pageSize + 1 }}–{{ Math.min(page * pageSize, totalItems) }}
        de {{ totalItems }}
      </span>
    </div>
  </div>
  <div class="mb-2 m-4">
    <table cTable [hover]="true" class="m-4" [responsive]="true" small>
      <thead>
        <tr>
          <th scope="col" style="width:48px">#</th>
          <th scope="col">Dominio</th>
          <th scope="col">URL</th>
          <th scope="col">Estrategia</th>
          <th scope="col">Estado</th>
          <th scope="col">Errores</th>
          <th scope="col">Warnings</th>
          <th scope="col">Oport.</th>
          <th style="width:120px">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let s of scrapsFiltrados; let i = index">
          <th scope="row">{{ s.id }}</th>

          <td>
            <span class="text-light text-truncate d-inline-block" style="max-width:220px">
              {{ s.dominio || '—' }}
            </span>
          </td>

          <td>
            <span class="badge bg-warning text-dark border text-truncate d-inline-block" style="max-width:320px">
              {{ s.url }}
            </span>
          </td>

          <td>
            <span class="badge text-bg-info text-dark text-truncate d-inline-block" style="max-width:120px">
              {{ (s.estrategia || '—') | titlecase }}
            </span>
          </td>

          <td>
            <span class="badge" [ngClass]="estadoBadgeClass(s.status)">
              {{ (s.status || '—') | titlecase }}
            </span>
          </td>

          <td>
            <c-badge color="danger">{{ totalesOf(s)?.errores ?? 0 }}</c-badge>
          </td>

          <td>
            <c-badge color="warning">{{ totalesOf(s)?.warnings ?? 0 }}</c-badge>
          </td>

          <td>
            <c-badge color="success">{{ totalesOf(s)?.oportunidades ?? 0 }}</c-badge>
          </td>

          <td class="d-flex" style="padding: 5px 12px;" *ngIf="s.status === 'error' || s.status === 'completado'">
            <button cButton color="primary" *ngIf="s.status === 'error' || s.status === 'completado'" size="sm"
              [cPopover]="'Ver detalle (Recuerda que el Scrap debe estar en estado Completado)'"
              [cPopoverTrigger]="'hover'" [cPopoverPlacement]="'top'" (click)="verDetalle(s)" class="me-2">
              <c-icon name="cil-magnifying-glass"></c-icon>
            </button>

            <button cButton color="secondary" size="sm" [cPopover]="'Reintentar scraping'" [cPopoverTrigger]="'hover'"
              [cPopoverPlacement]="'top'" (click)="reintentar(s)"
              *ngIf="s.status === 'error' || s.status === 'completado'">
              <svg cIcon name="cilReload" size="lg" style="cursor: pointer;"></svg>
            </button>

          </td>
          <td *ngIf="s.status != 'error' && s.status != 'completado'">
            <span class="badge me-2" [ngClass]="estadoBadgeClass(s.status)">
              Sin acciones
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>



  <!-- Paginación -->
  <ul cPagination style="cursor: pointer;" class="m-4 pagination pagination-sm justify-content-end mt-3">
    <li cPageItem [disabled]="page === 1">
      <a cPageLink (click)="goTo(1)">&laquo;</a>
    </li>
    <li cPageItem [disabled]="page === 1">
      <a cPageLink (click)="goTo(page - 1)">Anterior</a>
    </li>

    <li cPageItem *ngFor="let p of pages" [active]="page === p">
      <a cPageLink (click)="goTo(p)">{{ p }}</a>
    </li>

    <li cPageItem [disabled]="page === totalPages">
      <a cPageLink (click)="goTo(page + 1)">Siguiente</a>
    </li>
    <li cPageItem [disabled]="page === totalPages">
      <a cPageLink (click)="goTo(totalPages)">&raquo;</a>
    </li>
  </ul>

</c-card>

<!-- Modal de generación -->
<c-modal [visible]="detailVisible" backdrop="static" alignment="center" (close)="closeGenerateModal()"
  [scrollable]="true" size="xl">
  <c-modal-header>
    <h5 class="modal-title">Detalle Auditoria</h5>
    <button cButtonClose (click)="detailVisible=false"></button>
  </c-modal-header>
  <c-modal-body>
    <!-- KPIs principales -->
    <div class="row g-3 mt-1 m-4" *ngIf="data">
      <div class="col-6 col-md-3">
        <c-card class="shadow-sm border-0">
          <c-card-body class="py-3 bg-danger">
            <div class="text-muted small">Errores</div>
            <div class="h3 m-0">{{ totales?.errores ?? 0 }}</div>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-6 col-md-3">
        <c-card class="shadow-sm border-0">
          <c-card-body class="py-3 bg-warning">
            <div class="text-muted small">Warnings</div>
            <div class="h3 m-0">{{ totales?.warnings ?? 0 }}</div>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-6 col-md-3">
        <c-card class="shadow-sm border-0">
          <c-card-body class="py-3 bg-success">
            <div class="text-muted small">Oportunidades</div>
            <div class="h3 m-0">{{ totales?.oportunidades ?? 0 }}</div>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-6 col-md-3">
        <c-card class="shadow-sm border-0">
          <c-card-body class="py-3">
            <div class="text-muted small">Performance</div>
            <div class="h3 m-0">{{ scores?.performance ?? 0 }}%</div>
            <div class="small text-muted">SEO: {{ scores?.seo ?? 0 }}%</div>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- Encabezados detectados -->
    <c-card class="mb-4 m-4" *ngIf="summary && headings">
      <c-card-header>
        <strong>Encabezados (Headings)</strong>
      </c-card-header>
      <c-card-body>
        <div class="d-flex gap-3 flex-wrap mb-3">
          <c-badge color="primary">H1: {{ headings.h1 || 0 }}</c-badge>
          <c-badge color="info">H2: {{ headings.h2 || 0 }}</c-badge>
          <c-badge color="secondary">H3: {{ headings.h3 || 0 }}</c-badge>
        </div>

        <!-- Muestras H1 -->
        <div class="mt-3" *ngIf="headings.samples?.h1 && headings.samples.h1.length > 0">
          <h6 class="text-primary">
            <strong>Muestras H1</strong>
            <c-badge color="primary" class="ms-2">{{ headings.samples.h1.length }}</c-badge>
          </h6>
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let h of headings.samples.h1">{{ h }}</li>
          </ul>
        </div>

        <!-- Muestras H2 -->
        <div class="mt-3" *ngIf="headings.samples?.h2 && headings.samples.h2.length > 0">
          <h6 class="text-info">
            <strong>Muestras H2</strong>
            <c-badge color="info" class="ms-2">{{ headings.samples.h2.length }}</c-badge>
          </h6>
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let h of headings.samples.h2">{{ h }}</li>
          </ul>
        </div>

        <!-- Muestras H3 -->
        <div class="mt-3" *ngIf="headings.samples?.h3 && headings.samples.h3.length > 0">
          <h6 class="text-secondary">
            <strong>Muestras H3</strong>
            <c-badge color="secondary" class="ms-2">{{ headings.samples.h3.length }}</c-badge>
          </h6>
          <ul class="list-group list-group-flush">
            <li class="list-group-item" *ngFor="let h of headings.samples.h3">{{ h }}</li>
          </ul>
        </div>

        <!-- Mensaje si no hay muestras -->
        <div class="alert alert-info mt-3" *ngIf="!headings.samples || 
                (!headings.samples.h1?.length && 
                 !headings.samples.h2?.length && 
                 !headings.samples.h3?.length)">
          No se encontraron muestras de encabezados en la página.
        </div>
      </c-card-body>
    </c-card>

    <!-- Enlaces -->
    <c-card class="mb-4 m-4" *ngIf="summary && links">
      <c-card-header>
        <strong>Enlaces</strong>
      </c-card-header>
      <c-card-body>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="text-muted small">Total</div>
            <div class="h4 mb-0">{{ links.total || 0 }}</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small">Internos</div>
            <div class="h4 mb-0 text-success">{{ links.internal || 0 }}</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small">Externos</div>
            <div class="h4 mb-0 text-primary">{{ links.external || 0 }}</div>
          </div>
        </div>

        <!-- Enlaces internos -->
        <div *ngIf="links.samples?.internal && links.samples.internal.length > 0">
          <h6 class="text-success">
            <strong>Enlaces Internos</strong>
            <c-badge color="success" class="ms-2">{{ links.samples.internal.length }}</c-badge>
          </h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <tbody>
                <tr *ngFor="let l of links.samples.internal; let i = index">
                  <td class="text-muted" style="width: 30px;">{{ i + 1 }}</td>
                  <td><small class="text-break">{{ l }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Enlaces externos -->
        <div class="mt-3" *ngIf="links.samples?.external && links.samples.external.length > 0">
          <h6 class="text-primary">
            <strong>Enlaces Externos</strong>
            <c-badge color="primary" class="ms-2">{{ links?.samples?.external?.length }}</c-badge>
          </h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <tbody>
                <tr *ngFor="let l of links?.samples?.external; let i = index">
                  <td class="text-muted" style="width: 30px;">{{ i + 1 }}</td>
                  <td><small class="text-break">{{ l }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Mensaje si no hay enlaces -->
        <div class="alert alert-warning mt-3" *ngIf="links?.total === 0">
          No se encontraron enlaces en la página.
        </div>
      </c-card-body>
    </c-card>

    <c-card class="mb-4 m-4" *ngIf="top_words && top_words.length > 0">
      <c-card-header>
        <strong>Análisis de Contenido</strong>
      </c-card-header>
      <c-card-body>
        <div class="mb-3">
          <div class="text-muted small">Total de palabras</div>
          <div class="h4 mb-0">{{ word_count || 0 }}</div>
          <!-- Debug temporal -->
          <small class="text-danger">Debug: {{ word_count }} palabras | {{ top_words?.length || 0 }} términos
            únicos</small>
        </div>

        <div *ngIf="top_words && top_words.length > 0">
          <h6><strong>Palabras más frecuentes</strong></h6>
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th style="width: 50px;">#</th>
                  <th>Palabra</th>
                  <th style="width: 100px;">Frecuencia</th>
                  <th style="width: 150px;">% del total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let w of top_words; let i = index">
                  <td class="text-muted">{{ i + 1 }}</td>
                  <td><strong>{{ w[0] }}</strong></td>
                  <td>
                    <c-badge color="info">{{ w[1] }}</c-badge>
                  </td>
                  <td>
                    <small class="text-muted">
                      {{ getWordPercentage(w[1], word_count) }}%
                    </small>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="alert alert-info" *ngIf="!top_words || top_words.length === 0">
          No se encontraron palabras clave en la página.
          <!-- Debug temporal -->
          <br><small>Debug - word_count: {{ word_count }}, top_words length: {{ top_words?.length }}</small>
        </div>
      </c-card-body>
    </c-card>
    <!-- Charts -->
    <div class="row g-3 mt-1 m-4" *ngIf="charts">
      <div class="col-12 col-lg-4">
        <c-card class="shadow-sm border-0 h-100">
          <c-card-header><strong>Lighthouse Scores</strong></c-card-header>
          <c-card-body>
            <c-chart type="bar" [data]="charts.scoresBar" [options]="charts.barOptions"></c-chart>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-12 col-lg-4">
        <c-card class="shadow-sm border-0 h-100">
          <c-card-header><strong>KPIs (ms)</strong></c-card-header>
          <c-card-body>
            <c-chart type="bar" [data]="charts.kpisBar" [options]="charts.barOptions"></c-chart>
          </c-card-body>
        </c-card>
      </div>
      <div class="col-12 col-lg-4">
        <c-card class="shadow-sm border-0 h-100">
          <c-card-header><strong>Totales</strong></c-card-header>
          <c-card-body>
            <c-chart type="pie" [data]="charts.totalesPie" [options]="charts.options"></c-chart>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- Top Risks -->
    <c-card class="mt-4 shadow-sm border-0 m-4" *ngIf="topRisks?.length">
      <c-card-header><strong>Riesgos principales</strong></c-card-header>
      <c-card-body>
        <div class="vstack gap-3">
          <div *ngFor="let r of topRisks" class="p-3 rounded border">
            <div class="d-flex justify-content-between align-items-start">
              <strong class="me-2">{{ r.titulo }}</strong>
              <c-badge [color]="(r.prioridad || '').toLowerCase() === 'alta' ? 'danger' : 'warning'">
                {{ r.prioridad || '—' }}
              </c-badge>
            </div>
            <div class="text-muted small mt-1">{{ r.por_que_importa }}</div>
          </div>
        </div>
      </c-card-body>
    </c-card>

    <!-- Hallazgos -->
    <c-card class="mt-3 shadow-sm border-0 m-4" *ngIf="hallazgos?.length">
      <c-card-header><strong>Hallazgos unificados</strong></c-card-header>
      <c-card-body>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Título</th>
                <th>Impacto</th>
                <th>Prioridad</th>
                <th>Owner</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let h of hallazgos | slice:0:20">
                <td><c-badge color="secondary">{{ h.tipo }}</c-badge></td>
                <td>{{ h.categoria }}</td>
                <td>{{ h.titulo }}</td>
                <td class="small text-muted">U: {{ h.impacto_usuario }} · SEO: {{ h.impacto_seo }}</td>
                <td><c-badge [color]="(h.prioridad || '').toLowerCase()==='alta' ? 'danger' : 'warning'">{{ h.prioridad
                    }}</c-badge></td>
                <td class="small">{{ h.owner_sugerido }}</td>
              </tr>
            </tbody>
          </table>
          <div class="small text-muted" *ngIf="hallazgos.length > 20">Mostrando 20 de {{ hallazgos.length }}…</div>
        </div>
      </c-card-body>
    </c-card>

    <!-- Recomendaciones & Quick Wins -->
    <div class="row g-3 mt-1 m-4">
      <div class="col-12 col-lg-6" *ngIf="recomendaciones?.length">
        <c-card class="shadow-sm border-0 h-100">
          <c-card-header><strong>Recomendaciones IA</strong></c-card-header>
          <c-card-body>
            <div class="vstack gap-3">
              <div *ngFor="let r of recomendaciones">
                <strong>{{ r.titulo }}</strong>
                <div class="small text-muted">{{ r.rationale }}</div>
                <ul class="small mt-2" *ngIf="r.tareas?.length">
                  <li *ngFor="let t of r.tareas">{{ t }}</li>
                </ul>
              </div>
            </div>
          </c-card-body>
        </c-card>
      </div>

      <div class="col-12 col-lg-6" *ngIf="quickWins?.length">
        <c-card class="shadow-sm border-0 h-100">
          <c-card-header><strong>Quick Wins</strong></c-card-header>
          <c-card-body>
            <ul class="small mb-0">
              <li *ngFor="let q of quickWins">
                <strong>{{ q.titulo }}</strong> — {{ q.accion }}
                <span class="text-muted" *ngIf="q.kpi"> · KPI: {{ q.kpi }}</span>
                <span class="text-muted" *ngIf="q.due_in_dias"> · {{ q.due_in_dias }} días</span>
              </li>
            </ul>
          </c-card-body>
        </c-card>
      </div>
    </div>

    <!-- Next Steps por Sprint (desplegables) -->
    <c-card class="mt-3 shadow-sm border-0 m-4" *ngIf="sprintGroups?.length">
      <c-card-header><strong>Next steps por Sprint</strong></c-card-header>
      <c-card-body>
        <c-accordion [alwaysOpen]="false">
          <c-accordion-item *ngFor="let grp of sprintGroups" #item0="cAccordionItem" [visible]="false">
            <ng-template cTemplateId="accordionHeaderTemplate">
              <button cAccordionButton (click)="item0.toggleItem()" [collapsed]="!item0.visible">
                <span>{{ grp.key }} </span>
                <c-badge color="secondary" style="margin-left: 8px;"> {{ grp.items?.length || 0 }} tareas</c-badge>
              </button>
            </ng-template>
            <div class="vstack gap-3">
              <div *ngFor="let s of grp.items" class="p-2">
                <strong>{{ s.titulo }}</strong>

                <ul class="small mt-2 mb-2">
                  <li *ngFor="let t of s.tareas">{{ t }}</li>
                </ul>

                <div class="text-muted small" *ngIf="s.owner">Owner: {{ s.owner }}</div>
                <div class="text-muted small" *ngIf="s.kpi">KPI: {{ s.kpi }}</div>

                <details *ngIf="s.criterios_aceptacion?.length" class="mt-1">
                  <summary class="small text-muted">Criterios de aceptación</summary>
                  <ul class="small mt-2">
                    <li *ngFor="let c of s.criterios_aceptacion">{{ c }}</li>
                  </ul>
                </details>
              </div>
            </div>
          </c-accordion-item>
        </c-accordion>
      </c-card-body>
    </c-card>
  </c-modal-body>

</c-modal>